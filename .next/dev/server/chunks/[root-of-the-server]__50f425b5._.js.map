{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///Users/dillonroberts/Documents/open_banking_api_003/lib/store.ts"],"sourcesContent":["// Simple in-memory store. Single-process only (hackathon demo).\nlet ACCESS_TOKEN: string | null = null;\nlet OVERRIDE_TXNS: any[] | null = null;\n\nexport function setAccessToken(token: string) {\n  ACCESS_TOKEN = token;\n  // Reset CSV override when linking a bank\n  OVERRIDE_TXNS = null;\n}\nexport function getAccessToken() {\n  return ACCESS_TOKEN;\n}\n\nexport function setOverrideTransactions(txns: any[]) {\n  OVERRIDE_TXNS = txns;\n}\nexport function getOverrideTransactions() {\n  return OVERRIDE_TXNS;\n}\n\n\n"],"names":[],"mappings":"AAAA,gEAAgE;;;;;;;;;;;AAChE,IAAI,eAA8B;AAClC,IAAI,gBAA8B;AAE3B,SAAS,eAAe,KAAa;IAC1C,eAAe;IACf,yCAAyC;IACzC,gBAAgB;AAClB;AACO,SAAS;IACd,OAAO;AACT;AAEO,SAAS,wBAAwB,IAAW;IACjD,gBAAgB;AAClB;AACO,SAAS;IACd,OAAO;AACT","debugId":null}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///Users/dillonroberts/Documents/open_banking_api_003/pages/api/upload-csv.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport { IncomingForm, Files } from 'formidable';\nimport fs from 'node:fs';\nimport os from 'node:os';\nimport { parse } from 'csv-parse/sync';\nimport { setOverrideTransactions } from '@/lib/store';\n\nexport const config = {\n  api: { bodyParser: false },\n};\n\nfunction pick<T = any>(obj: any, keys: string[]): T | null {\n  for (const k of keys) {\n    if (obj[k] !== undefined && obj[k] !== null && obj[k] !== '') return obj[k];\n  }\n  return null;\n}\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  try {\n    const form = new IncomingForm({ multiples: false, uploadDir: os.tmpdir(), keepExtensions: true });\n    const { files } = await new Promise<{ fields: any; files: Files }>((resolve, reject) => {\n      form.parse(req, (err, fields, files) => (err ? reject(err) : resolve({ fields, files })));\n    });\n\n    const f: any = Array.isArray((files as any).file) ? (files as any).file[0] : (files as any).file;\n    const filepath: string | undefined = f?.filepath || f?.filepath || f?.path;\n    if (!filepath) {\n      res.status(400).send('Invalid CSV upload');\n      return;\n    }\n\n    const raw = fs.readFileSync(filepath, 'utf8');\n    const records: any[] = parse(raw, { columns: true, skip_empty_lines: true });\n\n    const txns = records.map((r, i) => {\n      const dateRaw = pick(r, ['date', 'Date', 'posted', 'Posting Date', 'Transaction Date']);\n      const dateStr = String(dateRaw || '').slice(0, 10);\n      const amountRaw = pick(r, ['amount', 'Amount', 'value', 'Value', 'Transaction Amount']);\n      const merchantRaw = pick(r, ['merchant_name', 'Merchant', 'Description', 'Name', 'Narrative', 'Details']);\n      const mccRaw = pick(r, ['mcc', 'MCC']);\n      const catRaw = pick(r, ['category', 'Category']);\n      const pfcRaw = pick(r, ['pfc', 'Personal Finance Category']);\n      const currencyRaw = pick(r, ['currency', 'Currency']) || 'GBP';\n      const timeRaw = pick(r, ['time', 'Time', 'Transaction Time']);\n\n      const amtNum = Number(String(amountRaw || '0').replace(/,/g, ''));\n      const cat: string[] =\n        typeof catRaw === 'string'\n          ? catRaw.split(/[>,]/).map(s => s.trim()).filter(Boolean)\n          : Array.isArray(catRaw)\n          ? catRaw\n          : [];\n\n      let datetime: string | null = null;\n      if (dateStr && timeRaw) {\n        const tClean = String(timeRaw).trim();\n        const maybeIso = new Date(`${dateStr} ${tClean}`);\n        if (!isNaN(maybeIso.getTime())) {\n          datetime = maybeIso.toISOString();\n        }\n      }\n\n      return {\n        id: r.id || r.transaction_id || `csv-${i}-${dateStr}`,\n        date: dateStr,\n        datetime,\n        amount: isFinite(amtNum) ? amtNum : 0,\n        merchant_name: String(merchantRaw || 'Unknown'),\n        mcc: mccRaw ? String(mccRaw) : null,\n        category: cat,\n        pfc: pfcRaw ? String(pfcRaw) : null,\n        currency: String(currencyRaw || 'GBP'),\n        _source: 'csv',\n      };\n    });\n\n    setOverrideTransactions(txns);\n\n    try { fs.unlinkSync(filepath); } catch {}\n\n    // Redirect to loading (then dashboard)\n    res.writeHead(303, { Location: '/loading' });\n    res.end();\n  } catch (e: any) {\n    res.status(400).send('Invalid CSV format');\n  }\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}}]
}